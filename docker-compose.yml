version: "3.9"

networks:
  codeps-network:
    external: true   # used by nginx-proxy

volumes:
  solarcom-mongo-data:

services:
  mongodb:
    image: mongo:7.0     # <-- match your FCV
    container_name: mongodb
    command: ["mongod","--bind_ip_all"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    ports:
      - "27017:27017"
    volumes:
      # Use Mongo's default data dir with a named volume
      - solarcom-mongo-data:/data/db
    networks: [codeps-network]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--username", "root", "--password", "password", "--authenticationDatabase", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo-express:
    image: mongo-express:latest
    container_name: mongo-express
    ports:
      - "9002:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://root:password@mongodb:27017/?authSource=admin
      ME_CONFIG_BASICAUTH: "false"   # set to "true" and add creds if you want auth
    depends_on:
      mongodb:
        condition: service_healthy
    networks: [codeps-network]
    restart: unless-stopped

  solarcom-app:
    container_name: solarcom-app
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    environment:
      # Override Mongo URI for in-network access (service name instead of localhost)
      SPRING_DATA_MONGODB_URI: mongodb://root:password@mongodb:27017/solarcomdb?authSource=admin

      # Mail creds picked up by application.yml as ${MAIL_USER}/${MAIL_PASS}
      MAIL_USER: your@gmail.com
      MAIL_PASS: your-app-password   # Use a Gmail App Password if using Gmail SMTP

      # Optional: choose a Spring profile and JVM opts
      SPRING_PROFILES_ACTIVE: default
      JAVA_OPTS: "-XX:MaxRAMPercentage=75 -XX:+UseG1GC"
    depends_on:
      mongodb:
        condition: service_healthy
    networks: [codeps-network]
    restart: unless-stopped
    # If you have Actuator, you can enable this:
    # healthcheck:
    #   test: ["CMD", "wget", "-qO-", "http://localhost:8080/actuator/health"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 5
    web:
    build:
      context: ../frontend
      args:
        # Build-time vars for Vite; include base path so assets work at /app/
        VITE_GOOGLE_MAPS_API_KEY: "${VITE_GOOGLE_MAPS_API_KEY}"
        VITE_GOOGLE_MAPS_ID: "${VITE_GOOGLE_MAPS_ID}"
        # VITE_BASE_PATH: "/app/"
        VITE_API_URL: "https://solarcom.folyideaz.com"
    container_name: solarcom-web
    restart: always
    depends_on: [app]
    environment:
      # Tell nginx-proxy to route this vhost to this container (port 80 inside)
      VIRTUAL_HOST: "solarcom.folyideaz.com"
      LETSENCRYPT_HOST: "solarcom.folyideaz.com"
      # Optional: increase body size if you upload files
      CLIENT_MAX_BODY_SIZE: 50m
    expose:
      - "80"     # internal only
    # volumes:
    #   # Provide custom nginx config (see step 3) to serve under /app and proxy /app/api
    #   - ./nginx-app.conf:/etc/nginx/conf.d/default.conf:ro
    networks: [codeps-network]

